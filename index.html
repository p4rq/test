<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- Iframe optimization -->
  <meta name="robots" content="noindex, nofollow">
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
  <title>Create Job</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Iframe optimization styles */
    body {
      margin: 0;
      padding: 1rem;
      min-height: 100vh;
      background: #f8f9fa;
    }
    
    /* Responsive iframe adjustments */
    @media (max-width: 768px) {
      body { padding: 0.5rem; }
      .container-fluid { padding: 0; }
    }
    
    /* Remove scrollbars in iframe */
    .iframe-embedded {
      overflow: hidden;
      height: 100vh;
    }
  </style>
</head>
<body class="p-4">

  <form id="jobForm">
    <div class="row g-3">

      <!-- Client details -->
      <div class="col-md-6">
        <h5>Client details</h5>
        <input type="text" class="form-control mb-2" name="first_name" placeholder="First name" required>
        <input type="text" class="form-control mb-2" name="last_name" placeholder="Last name" required>
        <input type="tel" class="form-control mb-2" name="phone" placeholder="Phone" required>
        <input type="email" class="form-control" name="email" placeholder="Email (optional)">
      </div>

      <!-- Job details -->
      <div class="col-md-6">
        <h5>Job details</h5>
        <select class="form-select mb-2" name="job_type" required>
          <option value="">Job type</option>
          <option value="Installation">Installation</option>
          <option value="Repair">Repair</option>
          <option value="Maintenance">Maintenance</option>
          <option value="Consultation">Consultation</option>
        </select>
        <select class="form-select mb-2" name="job_source">
          <option value="">Job source</option>
          <option value="Website">Website</option>
          <option value="Phone">Phone</option>
          <option value="Referral">Referral</option>
          <option value="Social Media">Social Media</option>
        </select>
        <textarea class="form-control" name="job_description" placeholder="Job description (optional)"></textarea>
      </div>

      <!-- Service location -->
      <div class="col-md-6">
        <h5>Service location</h5>
        <input type="text" class="form-control mb-2" name="address" placeholder="Address" required>
        <input type="text" class="form-control mb-2" name="city" placeholder="City" required>
        <input type="text" class="form-control mb-2" name="state" placeholder="State">
        <div class="row">
          <div class="col-6">
            <input type="text" class="form-control" name="zip_code" placeholder="Zip code">
          </div>
          <div class="col-6">
            <select class="form-select" name="area">
              <option value="">Area</option>
              <option value="North">North</option>
              <option value="South">South</option>
              <option value="East">East</option>
              <option value="West">West</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Scheduled -->
      <div class="col-md-6">
        <h5>Scheduled</h5>
        <input type="date" class="form-control mb-2" name="start_date" required>
        <div class="row mb-2">
          <div class="col-6">
            <input type="time" class="form-control" name="start_time" placeholder="Start time">
          </div>
          <div class="col-6">
            <input type="time" class="form-control" name="end_time" placeholder="End time">
          </div>
        </div>
        <small class="text-muted">–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–∑–∂–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞</small>
        <select class="form-select" name="test_select">
          <option value="">Test select</option>
          <option value="option1">Option 1</option>
        </select>
      </div>

    </div>

    <div class="mt-3">
      <button type="submit" class="btn btn-primary">Save Job</button>
      <small class="text-muted d-block mt-2">* –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</small>
    </div>
  </form>

  <script>
document.getElementById('jobForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const formData = new FormData(this);
  const data = Object.fromEntries(formData.entries());

  const apiToken = "c40a439d34337a700705c1f1b902ffeb83ee2297";

  try {
    // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–ª–µ–π –¥–ª—è —Å–¥–µ–ª–æ–∫
    console.log('–ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª–µ–π –¥–ª—è —Å–¥–µ–ª–æ–∫...');
    let fieldsRes = await fetch(`https://api.pipedrive.com/v1/dealFields?api_token=${apiToken}`);
    let fieldsResult = await fieldsRes.json();
    console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Å–¥–µ–ª–æ–∫:', fieldsResult);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–æ–∑–¥–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    const requiredFields = [
      { name: "Job Type", key: "job_type", field_type: "enum", options: ["Installation", "Repair", "Maintenance", "Consultation"] },
      { name: "Job Source", key: "job_source", field_type: "enum", options: ["Website", "Phone", "Referral", "Social Media"] },
      { name: "Job Description", key: "job_description", field_type: "text" },
      { name: "Service Address", key: "service_address", field_type: "text" },
      { name: "Service City", key: "service_city", field_type: "text" },
      { name: "Service State", key: "service_state", field_type: "text" },
      { name: "Service Zip Code", key: "service_zip_code", field_type: "text" },
      { name: "Service Area", key: "service_area", field_type: "enum", options: ["North", "South", "East", "West"] },
      { name: "Service Start Date", key: "service_start_date", field_type: "date" },
      { name: "Service Start Time", key: "service_start_time", field_type: "time" },
      { name: "Service End Time", key: "service_end_time", field_type: "time" }
    ];

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫–∏–µ –ø–æ–ª—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
    const existingFields = fieldsResult.success ? fieldsResult.data.map(f => f.name.toLowerCase()) : [];
    
    // –°–æ–∑–¥–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–æ–ª—è
    for (const field of requiredFields) {
      if (!existingFields.includes(field.name.toLowerCase())) {
        console.log(`–°–æ–∑–¥–∞–µ–º –ø–æ–ª–µ: ${field.name}`);
        try {
          const fieldPayload = {
            name: field.name,
            field_type: field.field_type
          };
          
          if (field.options) {
            fieldPayload.options = field.options.map(opt => ({ label: opt }));
          }

          let createFieldRes = await fetch(`https://api.pipedrive.com/v1/dealFields?api_token=${apiToken}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(fieldPayload)
          });
          
          let createFieldResult = await createFieldRes.json();
          if (createFieldResult.success) {
            console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–æ –ø–æ–ª–µ: ${field.name}`);
          } else {
            console.log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª–µ ${field.name}:`, createFieldResult.error);
          }
        } catch (err) {
          console.error(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—è ${field.name}:`, err);
        }
      } else {
        console.log(`‚úÖ –ü–æ–ª–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${field.name}`);
      }
    }

    // –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ–ª–µ–π –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
    let updatedFieldsRes = await fetch(`https://api.pipedrive.com/v1/dealFields?api_token=${apiToken}`);
    let updatedFieldsResult = await updatedFieldsRes.json();

    // 1. –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–∞–∫—Ç
    let personRes = await fetch(`https://api.pipedrive.com/v1/persons?api_token=${apiToken}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: `${data.first_name} ${data.last_name}`,
        phone: data.phone,
        email: data.email
      })
    });

    let personResult = await personRes.json();
    if (!personResult.success) {
      throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞');
    }
    let personId = personResult.data.id;

    // 2. –°–æ–∑–¥–∞—ë–º —Å–¥–µ–ª–∫—É –∏ –ø—ã—Ç–∞–µ–º—Å—è –¥–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ Details —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–ª—è
    let dealPayload = {
      title: `${data.first_name} ${data.last_name} - ${data.job_type || '–°–µ—Ä–≤–∏—Å'}`,
      person_id: personId,
      value: 0,
      currency: "USD",
      status: "open"
    };

    // –ü–æ–ø—Ä–æ–±—É–µ–º –¥–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ Details
    if (data.start_date) {
      dealPayload.expected_close_date = data.start_date; // –û–∂–∏–¥–∞–µ–º–∞—è –¥–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
    }

    let dealRes = await fetch(`https://api.pipedrive.com/v1/deals?api_token=${apiToken}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(dealPayload)
    });

    let dealResult = await dealRes.json();
    console.log('Deal API Response:', dealResult);
    
    if (dealResult.success) {
      const dealId = dealResult.data.id;
      
      // 3. –°–æ–∑–¥–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è —á–µ—Ä–µ–∑ API –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
      console.log('–û–±–Ω–æ–≤–ª—è–µ–º —Å–¥–µ–ª–∫—É —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –ø–æ–ª—è–º–∏...');
      
      // –ü–æ–ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —Å–¥–µ–ª–∫—É —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
      const customFieldsUpdate = {};
      
      // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–æ–ª–µ–π –≤ Pipedrive
      // –§–æ—Ä–º–∞—Ç: —á–∏—Å–ª–æ–≤–æ–π ID –ø–æ–ª—è –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏ –∏–ª–∏ —Ö—ç—à –∫–ª—é—á
      if (updatedFieldsResult.success && updatedFieldsResult.data) {
        updatedFieldsResult.data.forEach(field => {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ field –∏ field.id —Å—É—â–µ—Å—Ç–≤—É—é—Ç
          if (!field || !field.key) {
            return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–ª—è –±–µ–∑ –∫–ª—é—á–∞
          }
          
          const fieldKey = field.key;
          const fieldName = field.name ? field.name.toLowerCase() : '';
          
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ö—ç—à –∫–ª—é—á–∏ –¥–ª—è –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          if (fieldName.includes('job type') || fieldKey.includes('job_type')) {
            customFieldsUpdate[fieldKey] = data.job_type;
          }
          if (fieldName.includes('job source') || fieldKey.includes('job_source')) {
            customFieldsUpdate[fieldKey] = data.job_source;
          }
          if (fieldName.includes('job description') || fieldKey.includes('description')) {
            customFieldsUpdate[fieldKey] = data.job_description;
          }
          if (fieldName.includes('service address') || fieldKey.includes('address')) {
            customFieldsUpdate[fieldKey] = data.address;
          }
          if (fieldName.includes('service city') || fieldKey.includes('city')) {
            customFieldsUpdate[fieldKey] = data.city;
          }
          if (fieldName.includes('service state') || fieldKey.includes('state')) {
            customFieldsUpdate[fieldKey] = data.state;
          }
          if (fieldName.includes('zip code') || fieldKey.includes('zip')) {
            customFieldsUpdate[fieldKey] = data.zip_code;
          }
          if (fieldName.includes('service area') || fieldKey.includes('area')) {
            customFieldsUpdate[fieldKey] = data.area;
          }
          if (fieldName.includes('start date') || fieldKey.includes('start_date')) {
            customFieldsUpdate[fieldKey] = data.start_date;
          }
          if (fieldName.includes('start time') || fieldKey.includes('start_time')) {
            customFieldsUpdate[fieldKey] = data.start_time;
          }
          if (fieldName.includes('end time') || fieldKey.includes('end_time')) {
            customFieldsUpdate[fieldKey] = data.end_time;
          }
        });
      }

      if (Object.keys(customFieldsUpdate).length > 0) {
        console.log('–û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è:', customFieldsUpdate);
        let customUpdateRes = await fetch(`https://api.pipedrive.com/v1/deals/${dealId}?api_token=${apiToken}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(customFieldsUpdate)
        });
        
        let customUpdateResult = await customUpdateRes.json();
        console.log('Custom fields update result:', customUpdateResult);
      }

      alert(`‚úÖ –°–¥–µ–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!\nID: ${dealResult.data.id}\n–ö–æ–Ω—Ç–∞–∫—Ç: ${data.first_name} ${data.last_name}\n\nüìã –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Å–µ–∫—Ü–∏–∏ Details.\nüîß –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è —Å–æ–∑–¥–∞–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–µ—Å–ª–∏ —Ç—Ä–µ–±–æ–≤–∞–ª–æ—Å—å).`);
      
      // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
      document.getElementById('jobForm').reset();
    } else {
      console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏:', dealResult);
      throw new Error(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏: ${dealResult.error || JSON.stringify(dealResult.error_info || dealResult)}`);
    }

  } catch (err) {
    console.error('–ü–æ–¥—Ä–æ–±–Ω–∞—è –æ—à–∏–±–∫–∞:', err);
    alert(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${err.message}`);
  }
});

  </script>

</body>
</html>
